<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"><title>Stereo Layer Background</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    button { position: absolute; bottom: 20px; left: 20px; z-index: 10; padding: 10px; }
    #hud { position: absolute; top: 20px; left: 20px; color: white; z-index: 10; }
  </style>
</head>
<body>
  <video id="v" autoplay playsinline muted style="display:none;"></video>
  <button id="enter">Enter VR</button>
  <div id="hud">Loadingâ€¦</div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.169.0/build/three.module.js";
    import { VRButton } from "https://unpkg.com/three@0.169.0/examples/jsm/webxr/VRButton.js";

    const video = document.getElementById('v'), hud = document.getElementById('hud');
    const scene = new THREE.Scene();
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    renderer.autoClear = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(VRButton.createButton(renderer));

    async function start() {
      const pc = new RTCPeerConnection();
      pc.ontrack = ev => { video.srcObject = ev.streams[0]; video.play(); };
      const offer = await pc.createOffer({ offerToReceiveVideo: true });
      await pc.setLocalDescription(offer);
      let promise = new Promise((resolve) => {
          if (pc.iceGatheringState === 'complete') {
              resolve();
          } else {
              const checkState = () => {
                  if (pc.iceGatheringState === 'complete') {
                      pc.removeEventListener('icegatheringstatechange', checkState);
                      resolve();
                  }
              };
              pc.addEventListener('icegatheringstatechange', checkState);
          }
      });
      await promise;
      const resp = await fetch('/offer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sdp: offer.sdp, type: offer.type }) });
      const answer = await resp.json();
      await pc.setRemoteDescription(answer);
      hud.textContent = "WebRTC connected";
    }

    renderer.xr.addEventListener('sessionstart', async () => {
      const session = renderer.xr.getSession();
      const refSpace = await session.requestReferenceSpace('local');
      if (!session.renderState.layers) return hud.textContent = "Layers not supported";

      const binding = new XRMediaBinding(session);
      const layer = binding.createQuadLayer(video, { space: refSpace, layout: 'stereo-left-right', width: 10, height: 10 });
      session.updateRenderState({ layers: [layer] });
    });

    renderer.setAnimationLoop(() => {
      renderer.render(scene, new THREE.PerspectiveCamera());
    });

    document.getElementById('enter').onclick = () => document.querySelector('button[aria-label="Enter VR"]').click();

    start();
  </script>
</body>
</html>
